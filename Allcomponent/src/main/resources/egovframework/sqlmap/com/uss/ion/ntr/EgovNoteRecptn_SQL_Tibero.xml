<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 
	수정일                 수정자                          수정내용
  =========     =======    =================================================
  2011.8.12   	안민정     	 	테이블 표준화에 따른 수정사항 반영
							DELETE_YN	->	DELETE_AT
-->
<sqlMap namespace="NoteRecptn">
	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias  alias="comDefaultVO" type="egovframework.com.cmm.ComDefaultVO"/>
	
	
	<!-- 받은편지함관리::개봉으로 업데이트 -->
	<update id="NoteRecptn.updateNoteRecptnRelationOpenYn">
	UPDATE COMTNNOTERECPTN 
	SET
		OPEN_YN='Y',
		LAST_UPDT_PNTTM=sysdate,
		LAST_UPDUSR_ID=#lastUpdusrId#
	WHERE 1=1
		AND NOTE_ID=#noteId#
		AND NOTE_TRNSMIT_ID=#noteTrnsmitId#
		AND NOTE_RECPTN_ID=#noteRecptnId#
	</update>
		
	<!-- 받은편지함관리::상세 게시물정보 -->
	<select id="NoteRecptn.selectNoteRecptnDetail" resultClass="egovMap">
	 <![CDATA[
	SELECT 
	NOTE.NOTE_ID,
	NOTE_RNS.NOTE_TRNSMIT_ID,
	NOTE_RNS.NOTE_RECPTN_ID,
	NOTE_TNS.TRNSMITER_ID,
	(SELECT USER_NM FROM COMTNEMPLYRINFO WHERE ESNTL_ID = NOTE_TNS.TRNSMITER_ID) TRNSMITER_NM,
	TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD hh24:mi:ss') TRNSMITER_PNTTM,
	NOTE.NOTE_SJ,
	NOTE.NOTE_CN,
	NOTE.ATCH_FILE_ID,
	NOTE_RNS.RCVER_ID,
	(SELECT USER_NM FROM COMTNEMPLYRINFO WHERE ESNTL_ID = NOTE_RNS.RCVER_ID) RCVER_NM,
	TO_CHAR(NOTE_RNS.FRST_REGIST_PNTTM,'YYYY-MM-DD hh24:mi:ss') RCVER_PNTTM,
	NOTE_RNS.OPEN_YN,
	NOTE_RNS.RECPTN_SE
	FROM 
	     COMTNNOTE NOTE
	     LEFT OUTER JOIN COMTNNOTETRNSMIT NOTE_TNS ON (
	          NOTE.NOTE_ID=#noteId# AND NOTE.NOTE_ID=NOTE_TNS.NOTE_ID
	     )     
	     LEFT OUTER JOIN COMTNNOTERECPTN NOTE_RNS ON (
	          NOTE_TNS.NOTE_ID=NOTE_RNS.NOTE_ID AND 
	          NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID
	     )     
	WHERE 1=1
	AND NOTE_RNS.NOTE_ID=#noteId#
	AND NOTE_RNS.NOTE_TRNSMIT_ID=#noteTrnsmitId#
	AND NOTE_RNS.NOTE_RECPTN_ID=#noteRecptnId#
	]]>
	</select>
	
	<!-- 받은편지함관리::목록조회 게시물정보 -->
	<select id="NoteRecptn.selectNoteRecptn" parameterClass="comDefaultVO" resultClass="egovMap">
	<![CDATA[	
	SELECT *
	FROM (
	SELECT T0.*, ROWNUM RNUM
		FROM (
	]]>
	 <![CDATA[
	SELECT 
	NOTE.NOTE_ID,
	NOTE_RNS.NOTE_TRNSMIT_ID,
	NOTE_RNS.NOTE_RECPTN_ID,
	NOTE_TNS.TRNSMITER_ID,
	NOTE.NOTE_SJ,
	NOTE.NOTE_CN,
	NOTE.ATCH_FILE_ID,
	NOTE_RNS.RCVER_ID,
	NOTE_RNS.OPEN_YN,
	NOTE_RNS.RECPTN_SE,
	(SELECT USER_NM FROM COMTNEMPLYRINFO WHERE ESNTL_ID = NOTE_RNS.RCVER_ID) RCVER_NM,
	TO_CHAR(NOTE_RNS.FRST_REGIST_PNTTM,'YYYY-MM-DD hh24:mi:ss') FRST_REGISTER_PNTTM 
	FROM 
	     COMTNNOTE NOTE
	     LEFT OUTER JOIN COMTNNOTETRNSMIT NOTE_TNS ON (
         	NOTE.NOTE_ID=NOTE_TNS.NOTE_ID
	     )     
	     LEFT OUTER JOIN COMTNNOTERECPTN NOTE_RNS ON (
	          NOTE_TNS.NOTE_ID=NOTE_RNS.NOTE_ID  
	          AND NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID
	     )     
	WHERE 1=1
		AND NOTE_RNS.RCVER_ID = #rcverId#
	 ]]>
	 
	 <isNotEmpty property="searchKeyword">
	 	<isNotEqual property="searchKeyword" compareValue="">
		<isEqual property="searchCondition" compareValue="NOTE_RNS.RCVER_ID">
		<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTNEMPLYRINFO WHERE EMPLYR_ID = #searchKeyword#) ]]>
		</isEqual>
		<isEqual property="searchCondition" compareValue="NOTE_RNS.RCVER_NM">
		<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTNEMPLYRINFO WHERE USER_NM =  #searchKeyword#) ]]>
		</isEqual>
		<isEqual property="searchCondition" compareValue="NOTE.NOTE_SJ">
		AND NOTE.NOTE_SJ LIKE '%' || #searchKeyword# || '%'
		</isEqual>
		<isEqual property="searchCondition" compareValue="NOTE.NOTE_CN">
		AND NOTE.NOTE_CN LIKE '%' || #searchKeyword# || '%'
		</isEqual>
	 	</isNotEqual>
	 </isNotEmpty>
	 
	 <isNotEmpty property="searchFromDate">
	 <isNotEmpty property="searchToDate">
	 <![CDATA[ AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') >= #searchFromDate# AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') <= #searchToDate# ]]> 
	 </isNotEmpty>
	 </isNotEmpty>
	 
	 <![CDATA[
		ORDER BY NOTE.FRST_REGIST_PNTTM DESC
	]]>
	<![CDATA[	
		) T0
	) 
	WHERE ROWNUM BETWEEN #firstIndex# + 1 AND #firstIndex# + #recordCountPerPage#
	]]>
	</select>
	<!-- 받은편지함관리::목록조회_게시물 총갯수  -->
	<select id="NoteRecptn.selectNoteRecptnCnt" parameterClass="comDefaultVO" resultClass="int">
	
	SELECT 
		COUNT(*) totcnt
	FROM 
	     COMTNNOTE NOTE
	     LEFT OUTER JOIN COMTNNOTETRNSMIT NOTE_TNS ON (
	          NOTE.NOTE_ID=NOTE_TNS.NOTE_ID
	     )     
	     LEFT OUTER JOIN COMTNNOTERECPTN NOTE_RNS ON (
	          NOTE_TNS.NOTE_ID=NOTE_RNS.NOTE_ID 
	          AND NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID
	     )     
	WHERE 1=1
	AND NOTE_RNS.RCVER_ID = #rcverId#
	
	 <isNotEmpty property="searchKeyword">
	 	<isNotEqual property="searchKeyword" compareValue="">
		<isEqual property="searchCondition" compareValue="NOTE_RNS.RCVER_ID">
		<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTNEMPLYRINFO WHERE EMPLYR_ID = #searchKeyword#) ]]>
		</isEqual>
		<isEqual property="searchCondition" compareValue="NOTE_RNS.RCVER_NM">
		<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTNEMPLYRINFO WHERE USER_NM =  #searchKeyword#) ]]>
		</isEqual>
		<isEqual property="searchCondition" compareValue="NOTE.NOTE_SJ">
		AND NOTE.NOTE_SJ LIKE '%' || #searchKeyword# || '%'
		</isEqual>
		<isEqual property="searchCondition" compareValue="NOTE.NOTE_CN">
		AND NOTE.NOTE_CN LIKE '%' || #searchKeyword# || '%'
		</isEqual>
	 	</isNotEqual>
	 </isNotEmpty>
	 
	 <isNotEmpty property="searchFromDate">
	 <isNotEmpty property="searchToDate">
	 <![CDATA[ AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') >= #searchFromDate# AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') <= #searchToDate# ]]> 
	 </isNotEmpty>
	 </isNotEmpty>
	 
	</select>
	
	<!-- 받은편지함관리::보낸편지함 갯수 조회  -->
	<select id="NoteRecptn.selectNoteTrnsmitRelationCnt" resultClass="int">
	SELECT 
	COUNT(NOTE_ID) CNT
	FROM COMTNNOTETRNSMIT 
	WHERE 1=1 
	AND DELETE_AT='Y'
	AND NOTE_ID=#noteId#
	AND NOTE_TRNSMIT_ID=#noteTrnsmitId#
	</select>
	
	<!-- 받은편지함관리::받은편지함 갯수 조회  -->
	<select id="NoteRecptn.selectNoteRecptnRelationCnt" resultClass="int">
	SELECT 
	COUNT(NOTE_ID) CNT
	FROM COMTNNOTERECPTN  
	WHERE 1=1 
	AND NOTE_ID=#noteId#
	AND NOTE_TRNSMIT_ID=#noteTrnsmitId#
	</select>
	
    <!-- 받은편지함관리::삭제  -->
	<delete id="NoteRecptn.deleteNoteRecptn">
		<![CDATA[
			DELETE FROM COMTNNOTERECPTN 
			WHERE 1=1 
			AND NOTE_ID=#noteId# AND 
			NOTE_TRNSMIT_ID=#noteTrnsmitId# 
			AND NOTE_RECPTN_ID=#noteRecptnId# 
		]]>
	</delete>
	
	<!-- 보낸쪽지함삭제::삭제  -->
	<delete id="NoteRecptn.deleteNoteTrnsmit">
		<![CDATA[
			DELETE FROM COMTNNOTETRNSMIT 
			WHERE 1=1 
			AND NOTE_ID=#noteId#
			AND NOTE_TRNSMIT_ID=#noteTrnsmitId# 
		]]>
	</delete>
	<!-- 쪽지관리삭제::삭제  -->
	<delete id="NoteRecptn.deleteNoteManage">
		<![CDATA[
			DELETE FROM COMTNNOTE WHERE NOTE_ID=#noteId#
		]]>
	</delete>
	
	<!-- 받은편지함관리::쪽지정보/보낸쪽지 삭제  -->
	<delete id="NoteRecptn.deleteNoteRecptnRelation">
		<![CDATA[

			DELETE FROM COMTNNOTERECPTN 
			WHERE 1=1 
			AND NOTE_ID=#noteId#
			AND NOTE_TRNSMIT_ID=#noteTrnsmitId# 
			AND NOTE_RECPTN_ID=#noteRecptnId#;
			
			DELETE FROM COMTNNOTETRNSMIT
			WHERE 1=1 
			AND NOTE_ID=#noteId#
			AND NOTE_TRNSMIT_ID=#noteTrnsmitId#;
			
			DELETE FROM COMTNNOTE WHERE NOTE_ID=#noteId#;
		]]>
	</delete>
</sqlMap>